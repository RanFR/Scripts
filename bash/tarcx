#!/bin/bash

# ----------------------
# Time formatting
# ----------------------
format_time() {
  local seconds=$1
  local hours=$((seconds / 3600))
  local minutes=$(((seconds % 3600) / 60))
  local secs=$((seconds % 60))

  if (( hours > 0 )); then
    printf "%02d:%02d:%02d" "$hours" "$minutes" "$secs"
  else
    printf "%02d:%02d" "$minutes" "$secs"
  fi
}

# ----------------------
# Human-readable size
# ----------------------
format_bytes() {
  local bytes=$1
  local kib=$((1024))
  local mib=$((1024 * 1024))
  local gib=$((1024 * 1024 * 1024))
  local tib=$((1024 * 1024 * 1024 * 1024))

  if (( bytes >= tib )); then
    printf "%.2f TB" "$(echo "$bytes / $tib" | bc -l)"
  elif (( bytes >= gib )); then
    printf "%.2f GB" "$(echo "$bytes / $gib" | bc -l)"
  elif (( bytes >= mib )); then
    printf "%.2f MB" "$(echo "$bytes / $mib" | bc -l)"
  elif (( bytes >= kib )); then
    printf "%.2f KB" "$(echo "$bytes / $kib" | bc -l)"
  else
    printf "%d bytes" "$bytes"
  fi
}

# ----------------------
# Compression type
# ----------------------
detect_compression() {
  case "$1" in
    *.tar) echo "none" ;;
    *.tar.xz) echo "xz" ;;
    *.tar.gz) echo "gz" ;;
    *) echo "unknown" ;;
  esac
}

# ----------------------
# Archive Creation
# ----------------------
create_archive() {
  OUTPUT_FILE="$1"
  shift
  INPUTS=("$@")

  COMP_TYPE=$(detect_compression "$OUTPUT_FILE")
  if [ "$COMP_TYPE" == "unknown" ]; then
    echo "âŒ ä¸æ”¯æŒçš„è¾“å‡ºæ–‡ä»¶æ‰©å±•å."
    exit 2
  fi

  for item in "${INPUTS[@]}"; do
    if [ ! -e "$item" ]; then
      echo "âŒ é”™è¯¯ï¼š'$item' ä¸å­˜åœ¨."
      exit 3
    fi
  done

  echo "ğŸ“¦ åˆ›å»ºå½’æ¡£: $OUTPUT_FILE"
  echo "ğŸ“ åŒ…å«: ${INPUTS[*]}"
  echo "âš™ï¸ å‹ç¼©æ–¹å¼: $COMP_TYPE"
  echo "â³ æ­£åœ¨åˆ›å»ºå½’æ¡£..."

  # å¼€å§‹è®¡æ—¶
  START_TIME=$(date +%s)

  # å¯åŠ¨åå°è¿›ç¨‹æ˜¾ç¤ºè¿è¡Œæ—¶é—´
  (
    while kill -0 $$ 2>/dev/null; do
      CURRENT_TIME=$(date +%s)
      ELAPSED=$((CURRENT_TIME - START_TIME))
      FORMATTED_TIME=$(format_time "$ELAPSED")
      printf "\râ±ï¸  è¿è¡Œæ—¶é—´: %s" "$FORMATTED_TIME"
      sleep 1
    done
  ) &
  TIMER_PID=$!

  # ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©è®¡æ—¶å™¨å¯åŠ¨
  sleep 0.1

  case "$COMP_TYPE" in
    none)
      tar -cf "$OUTPUT_FILE" "${INPUTS[@]}"
      ;;
    xz)
      tar -cf - "${INPUTS[@]}" | xz -c > "$OUTPUT_FILE"
      ;;
    gz)
      tar -cf - "${INPUTS[@]}" | gzip > "$OUTPUT_FILE"
      ;;
  esac

  # åœæ­¢è®¡æ—¶å™¨
  kill $TIMER_PID 2>/dev/null
  wait $TIMER_PID 2>/dev/null

  # è®¡ç®—æœ€ç»ˆæ—¶é—´
  END_TIME=$(date +%s)
  TOTAL_TIME=$((END_TIME - START_TIME))
  FORMATTED_TOTAL=$(format_time "$TOTAL_TIME")
  printf "\r\033[Kâ±ï¸  æ€»ç”¨æ—¶: %s\n" "$FORMATTED_TOTAL"

  if [ $? -eq 0 ]; then
    echo "âœ… å½’æ¡£åˆ›å»ºæˆåŠŸ: $OUTPUT_FILE"
  else
    echo "âŒ å½’æ¡£åˆ›å»ºå¤±è´¥."
  fi
}

# ----------------------
# Archive Extraction
# ----------------------
extract_archive() {
  ARCHIVE="$1"
  DEST="${2:-.}"

  COMP_TYPE=$(detect_compression "$ARCHIVE")
  if [ "$COMP_TYPE" == "unknown" ]; then
    echo "âŒ ä¸æ”¯æŒçš„å½’æ¡£æ‰©å±•å."
    exit 2
  fi

  if [ ! -f "$ARCHIVE" ]; then
    echo "âŒ å½’æ¡£ '$ARCHIVE' æœªæ‰¾åˆ°."
    exit 3
  fi

  echo "ğŸ“‚ æ­£åœ¨æå– '$ARCHIVE' â†’ '$DEST'"
  echo "âš™ï¸ å‹ç¼©æ–¹å¼: $COMP_TYPE"
  echo "â³ æ­£åœ¨æå–å½’æ¡£..."
  mkdir -p "$DEST"

  # å¼€å§‹è®¡æ—¶
  START_TIME=$(date +%s)

  # å¯åŠ¨åå°è¿›ç¨‹æ˜¾ç¤ºè¿è¡Œæ—¶é—´
  (
    while kill -0 $$ 2>/dev/null; do
      CURRENT_TIME=$(date +%s)
      ELAPSED=$((CURRENT_TIME - START_TIME))
      FORMATTED_TIME=$(format_time "$ELAPSED")
      printf "\râ±ï¸  è¿è¡Œæ—¶é—´: %s" "$FORMATTED_TIME"
      sleep 1
    done
  ) &
  TIMER_PID=$!

  # ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©è®¡æ—¶å™¨å¯åŠ¨
  sleep 0.1

  case "$COMP_TYPE" in
    none)
      tar -xf "$ARCHIVE" -C "$DEST"
      ;;
    xz)
      xz -d -c "$ARCHIVE" | tar -x -C "$DEST"
      ;;
    gz)
      gzip -d -c "$ARCHIVE" | tar -x -C "$DEST"
      ;;
  esac

  # åœæ­¢è®¡æ—¶å™¨
  kill $TIMER_PID 2>/dev/null
  wait $TIMER_PID 2>/dev/null

  # è®¡ç®—æœ€ç»ˆæ—¶é—´
  END_TIME=$(date +%s)
  TOTAL_TIME=$((END_TIME - START_TIME))
  FORMATTED_TOTAL=$(format_time "$TOTAL_TIME")
  printf "\r\033[Kâ±ï¸  æ€»ç”¨æ—¶: %s\n" "$FORMATTED_TOTAL"

  if [ $? -eq 0 ]; then
    echo "âœ… æå–å®ŒæˆæˆåŠŸ."
  else
    echo "âŒ æå–å¤±è´¥."
  fi
}

# ----------------------
# Usage info
# ----------------------
usage() {
  echo "ä½¿ç”¨æ–¹æ³•:"
  echo "  $0 -c <è¾“å‡ºæ–‡ä»¶.tar{.xz,gz}> <æ–‡ä»¶...>        # åˆ›å»ºå½’æ¡£"
  echo "  $0 -x <å½’æ¡£æ–‡ä»¶.tar{.xz,gz}> [è¾“å‡ºç›®å½•]     # æå–å½’æ¡£"
  exit 1
}

# ----------------------
# Entry point with -c/-x options
# ----------------------
if [ $# -lt 2 ]; then
  usage
fi

MODE=""
POSITIONAL_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -c)
      MODE="create"
      shift
      ;;
    -x)
      MODE="extract"
      shift
      ;;
    -*)
      echo "æœªçŸ¥é€‰é¡¹: $1"
      usage
      ;;
    *)
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

if [ -z "$MODE" ]; then
  echo "âŒ é”™è¯¯ï¼šå¿…é¡»æŒ‡å®š -c (åˆ›å»º) æˆ– -x (æå–)"
  usage
fi

if [ "$MODE" = "create" ]; then
  create_archive "${POSITIONAL_ARGS[@]}"
elif [ "$MODE" = "extract" ]; then
  extract_archive "${POSITIONAL_ARGS[@]}"
else
  usage
fi
